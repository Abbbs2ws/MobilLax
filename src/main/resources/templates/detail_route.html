<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>대중교통 경로 안내</title>
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
  <script th:inline="javascript">
    const CUSTOMER_ID = /*[[${customerId}]]*/ "guest";
    const CUSTOMER_NAME = /*[[${customerName}]]*/ "이름없음";
    const CUSTOMER_EMAIL = /*[[${customerEmail}]]*/ "noemail@example.com";
  </script>
</head>
<body>
<h1>🧭 상세 경로 안내</h1>

<!-- ✅ 상세 경로 반복 -->
<div th:each="detail, detailStat : ${details}">
  <h2>🔻 경로 [[${detailStat.index} + 1]]</h2>

  <div th:each="leg : ${detail.legs}">
    <h3>
      [[${leg.role}]]
      <span th:switch="${leg.mode}">
        <span th:case="'WALK'">🚶</span>
        <span th:case="'TRAIN'">🚆</span>
        <span th:case="'EXPRESSBUS'">🚌</span>
        <span th:case="'SUBWAY'">🚇</span>
        <span th:case="'BUS'">🚌</span>
        <span th:case="*">🔁</span>
      </span>
    </h3>

    <ul>
      <li>출발지: [[${leg.start.name}]]</li>
      <li>도착지: [[${leg.end.name}]]</li>
      <li>소요 시간: [[${leg.formattedTime}]]</li>
      <li>거리: [[${leg.formattedDistance}]]</li>
      <li th:if="${leg.route != null}">노선명: [[${leg.route}]]</li>
      <li th:if="${leg.routeColor != null}">노선 색상: [[${leg.routeColor}]]</li>

      <!-- ✅ 구간 요금 및 장바구니 버튼 -->
      <li th:if="${leg.routePayment != null}">
        💸 구간 요금: [[${leg.routePayment}]]원
        <button type="button"
                th:attr="onclick=|addToCart('${leg.route}', [[${leg.routePayment}]], '${detailStat.index}')|">
          장바구니에 담기
        </button>
      </li>
    </ul>

    <!-- ✅ 도보 안내 -->
    <div th:if="${!#lists.isEmpty(leg.steps)}">
      <h4>📍 도보 안내</h4>
      <ul>
        <li th:each="step : ${leg.steps}" th:text="${step.description}"></li>
      </ul>
    </div>

    <!-- ✅ 정류장 목록 -->
    <div th:if="${!#lists.isEmpty(leg.stations)}">
      <h4>🅿️ 경유 정류장</h4>
      <ul>
        <li th:each="station : ${leg.stations}">
          [[${station.stationName}]] ([[${station.lon}]], [[${station.lat}]])
        </li>
      </ul>
    </div>

    <!-- ✅ 가능한 노선 -->
    <div th:if="${!#lists.isEmpty(leg.lanes)}">
      <h4>🚆 가능한 노선</h4>
      <ul>
        <li th:each="lane : ${leg.lanes}">
          [[${lane.route}]] (ID: [[${lane.routeId}]])
        </li>
      </ul>
    </div>

    <hr>
  </div>
</div>

<!-- ✅ 결제 버튼 -->
<button onclick="requestPayment()">🧾 선택한 구간 결제하기</button>

<!-- ✅ 장바구니 및 결제 처리 -->
<script>
  let cart = [];

  function addToCart(name, amount, routeId) {
    const itemId = `${routeId}-${name}`;
    if (cart.some(item => item.id === itemId)) {
      alert("이미 장바구니에 담긴 구간입니다.");
      return;
    }
    cart.push({
      name: name,
      amount: parseInt(amount),
      routeId: `route${routeId}`,
      id: itemId
    });
    alert(`🛒 ${name} 구간이 장바구니에 담겼습니다.`);
  }

  async function requestPayment() {
    if (cart.length === 0) {
      alert("장바구니가 비어 있습니다.");
      return;
    }

    const totalAmount = cart.reduce((sum, item) => sum + item.amount, 0);
    const portone = window.PortOne; // SDK v2 전역 객체
    const merchantUid = "order_" + new Date().getTime();

    try {
      const result = await portone.requestPayment({
        storeId: "store-xxxxxx",
        paymentId: merchantUid,
        payment: {
          amount: totalAmount,
          orderName: "대중교통 경로 요금",
          currency: "KRW",
        },
        payMethod: {
          type: "CARD",
        },
        customer: {
          customerId: CUSTOMER_ID,
          fullName: CUSTOMER_NAME,
          phoneNumber: "01012345678", // 별도로 사용자 정보가 있다면 동적으로 설정
          email: CUSTOMER_EMAIL,
        },
      });

      if (result.status === "PAID") {
        const confirmResponse = await fetch("/api/payment/confirm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            impUid: result.paymentId,
            merchantUid: merchantUid,
            userId: "user123",
            fareItems: cart,
            totalAmount: totalAmount
          })
        });

        const message = await confirmResponse.text();
        alert(message);
        cart = [];
      } else {
        alert("❌ 결제 실패 또는 미완료 상태입니다.");
      }
    } catch (e) {
      alert("❌ 결제 중 오류 발생: " + e.message);
    }
  }
</script>

</body>
</html>
